{{- if .Values.auth.enabled -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: access-control-model
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "chart.labels" . | nindent 4 }}
data:
  model.conf: |-
    [request_definition]
    r = sub, dom, obj, act

    [policy_definition]
    p = sub, dom, obj, act

    [role_definition]
    g = _, _, _

    [policy_effect]
    e = some(where (p.eft == allow))

    [matchers]
    m = g(r.sub, p.sub, r.dom) && globMatch(r.dom, p.dom) && globMatch(r.obj, p.obj) && r.act == p.act || r.sub == "superuser"
  policy.csv: |-
    p, virtual-service-creator, *, *, list-access-groups
    p, virtual-service-creator, *, *, list-virtual-services
    p, virtual-service-creator, *, *, list-virtual-service-templates
    p, virtual-service-creator, *, *, list-listeners
    p, virtual-service-creator, *, *, list-nodes
    p, virtual-service-creator, *, *, list-access-log-configs
    p, virtual-service-creator, *, *, list-http-filters
    p, virtual-service-creator, *, *, list-routes
    p, virtual-service-creator, *, *, get-virtual-service
    p, virtual-service-creator, *, *, create-virtual-service
    p, virtual-service-creator, *, *, update-virtual-service
    p, virtual-service-creator, *, *, fill-template

    p, virtual-service-reader, *, *, list-access-groups
    p, virtual-service-reader, *, *, list-virtual-services
    p, virtual-service-reader, *, *, list-virtual-service-templates
    p, virtual-service-reader, *, *, list-listeners
    p, virtual-service-reader, *, *, list-nodes
    p, virtual-service-reader, *, *, list-access-log-configs
    p, virtual-service-reader, *, *, list-http-filters
    p, virtual-service-reader, *, *, list-routes
    p, virtual-service-reader, *, *, get-virtual-service
    p, virtual-service-reader, *, *, fill-template

    g, admins, virtual-service-creator, *
    g, developers, virtual-service-reader, *
{{- end }}