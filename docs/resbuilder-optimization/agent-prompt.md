# Prompt для агента по оптимизации ResBuilder

Вы - специализированный агент по оптимизации Go кода, задачей которого является рефакторинг пакета `internal/xds/resbuilder` в проекте Envoy XDS Controller.

## Контекст задачи

Вам предстоит выполнить оптимизацию пакета `internal/xds/resbuilder` согласно плану в документе `docs/resbuilder-optimization/resbuilder-optimization.md`. Используйте **стратегию параллельной реализации** - создавайте новую версию рядом со старой, проводите бенчмарки и только после подтверждения корректности заменяйте старый код.

## Требования к работе

### Git коммиты
- Делайте коммиты после каждого значимого этапа работы
- Используйте короткие, описательные commit messages на английском языке
- Примеры хороших сообщений:
  - `refactor: create parallel resbuilder implementation`
  - `perf: optimize cluster extraction logic`
  - `test: add benchmarks for new vs old implementation`
  - `fix: reduce memory allocations in buildHTTPFilters`

### Документация прогресса
Ведите файл `docs/resbuilder-optimization/handoff.md` с обновлениями:
- Выполненные задачи с временными метками
- Текущий статус работы
- Результаты бенчмарков
- Проблемы и их решения
- Следующие шаги
- Инструкции для продолжающего работу

## План выполнения (по приоритету)

### Этап 1: Подготовка параллельной реализации
1. Создайте копию пакета `internal/xds/resbuilder_v2`
2. Настройте бенчмарк-тесты для сравнения производительности
3. Создайте тестовые данные для проверки корректности
4. **Коммит**: `setup: create parallel resbuilder v2 implementation`

### Этап 2: Оптимизация алгоритмов
1. **Кэширование результатов**:
   - Реализуйте кэш для результатов `buildHTTPFilters`
   - Добавьте мемоизацию для `clustersFrom*` функций
   - **Коммит**: `perf: implement caching for filters and clusters`

2. **Упрощение логики поиска кластеров**:
   - Замените JSON marshal/unmarshal на прямой обход структур
   - Объедините дублирующиеся функции `clustersFrom*`
   - **Коммит**: `refactor: optimize cluster extraction without JSON`

### Этап 3: Оптимизация структур данных
1. **Пулы объектов**:
   - Используйте `sync.Pool` для часто создаваемых объектов
   - Оптимизируйте аллокации slice'ов
   - **Коммит**: `perf: implement object pools and reduce allocations`

2. **Упрощение структуры Resources**:
   - Сделайте поля указателями где возможно
   - Добавьте методы для ленивой инициализации
   - **Коммит**: `refactor: optimize Resources structure`

### Этап 4: Рефакторинг архитектуры
1. **Разделение ответственности**:
   - Выделите отдельные builders для каждого типа ресурсов
   - Реализуйте паттерн Builder для сложной конфигурации
   - **Коммит**: `refactor: split builders by resource type`

2. **Улучшение обработки ошибок**:
   - Добавьте контекстную информацию к ошибкам
   - Реализуйте structured logging
   - **Коммит**: `improve: enhance error handling and logging`

### Этап 5: Валидация и бенчмарки
1. **Проведите полное тестирование**:
   - Убедитесь, что новая версия дает идентичные результаты
   - Запустите все существующие тесты
   - **Коммит**: `test: validate new implementation correctness`

2. **Бенчмарки**:
   - Измерьте производительность: CPU, память, время выполнения
   - Сравните с базовой версией
   - Задокументируйте результаты в handoff
   - **Коммит**: `perf: add comprehensive benchmarks`

### Этап 6: Интеграция
1. **Постепенная замена**:
   - Замените импорты на новую версию
   - Удалите старый код
   - Обновите документацию
   - **Коммит**: `feat: migrate to optimized resbuilder implementation`

## Критерии успеха

### Функциональность
- [ ] Новая версия дает идентичные результаты старой
- [ ] Все существующие тесты проходят
- [ ] Нет регрессий в поведении

### Производительность
- [ ] Снижение времени выполнения минимум на 20%
- [ ] Сокращение аллокаций памяти минимум на 30%
- [ ] Уменьшение пикового потребления памяти

### Качество кода
- [ ] Снижение цикломатической сложности
- [ ] Улучшение покрытия тестами
- [ ] Устранение code smells

## Шаблон handoff документа

```markdown
# Передача задач по оптимизации ResBuilder

## Статус: [В_РАБОТЕ/ЗАВЕРШЕНО/ЗАБЛОКИРОВАНО]
Последнее обновление: [ДАТА ВРЕМЯ]

## Выполненные задачи
- [ ] Задача 1 - [статус] - [дата] - [хеш коммита]
- [ ] Задача 2 - [статус] - [дата] - [хеш коммита]

## Текущий прогресс
[Подробное описание текущего состояния]

## Результаты бенчмарков
| Метрика | Старая реализация | Новая реализация | Улучшение |
|---------|------------------|-----------------|-----------|
| Время CPU | X мс | Y мс | на Z% быстрее |
| Память | X МБ | Y МБ | на Z% меньше |
| Аллокации | X | Y | на Z% меньше |

## Обнаруженные проблемы
1. [Описание проблемы] - [Решение/Статус]

## Следующие шаги
1. [Ближайшая задача]
2. [Последующие задачи]

## Инструкции для передачи
[Инструкции для следующего разработчика]

## Модифицированные файлы
- [Список измененных файлов с кратким описанием]
```

## Дополнительные указания

1. **Безопасность**: Всегда создавайте резервные копии перед масштабными изменениями
2. **Тестирование**: Запускайте тесты после каждого изменения
3. **Производительность**: Используйте `go test -bench=.` и `go test -benchmem` для измерений
4. **Профилирование**: При необходимости используйте `go tool pprof` для детального анализа
5. **Совместимость**: Сохраняйте обратную совместимость публичных API

Начните работу с создания handoff документа и первого коммита подготовки. Удачи!