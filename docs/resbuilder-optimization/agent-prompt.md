# Prompt для агента по оптимизации ResBuilder

Вы - специализированный агент по оптимизации Go кода, задачей которого является рефакторинг пакета `internal/xds/resbuilder` в проекте Envoy XDS Controller.

## Контекст задачи

Вам предстоит выполнить оптимизацию пакета `internal/xds/resbuilder` согласно плану в документе `docs/resbuilder-optimization/resbuilder-optimization.md`. Используйте **стратегию параллельной реализации** - создавайте новую версию рядом со старой, проводите бенчмарки и только после подтверждения корректности заменяйте старый код.

## Требования к работе

### Git коммиты
- Делайте коммиты после каждого значимого этапа работы
- Используйте короткие, описательные commit messages на английском языке
- Примеры хороших сообщений:
  - `refactor: create parallel resbuilder implementation`
  - `perf: optimize cluster extraction logic`
  - `test: add benchmarks for new vs old implementation`
  - `fix: reduce memory allocations in buildHTTPFilters`

### Документация прогресса
Ведите файл `docs/resbuilder-optimization/handoff.md` с обновлениями:
- Выполненные задачи с временными метками
- Текущий статус работы
- Результаты бенчмарков
- Проблемы и их решения
- Следующие шаги
- Инструкции для продолжающего работу

## План выполнения (по приоритету)

### Этап 1: Подготовка параллельной реализации ✓
1. Создайте копию пакета `internal/xds/resbuilder_v2` ✓
2. Настройте бенчмарк-тесты для сравнения производительности ✓
3. Создайте тестовые данные для проверки корректности ✓
4. **Коммит**: `setup: create parallel resbuilder v2 implementation` ✓

### Этап 2: Оптимизация алгоритмов ✓
1. **Кэширование результатов** ✓
2. **Упрощение логики поиска кластеров** ✓

### Этап 3: Оптимизация структур данных ✓
1. **Пулы объектов** ✓
   - Создан файл `utils/pools.go` с реализацией `sync.Pool` для слайсов строк, кластеров и HTTP фильтров ✓
   - Добавлены вспомогательные функции Get/Put для каждого типа пула ✓
   - Созданы функции безопасного копирования с использованием пулов ✓
   - **Коммит**: `perf: implement object pools and reduce allocations` ✓

2. **Улучшение стратегии кэширования** ✓
   - Создан файл `utils/lru.go` с общей реализацией LRU кэша с поддержкой TTL ✓
   - Реализована эффективная стратегия вытеснения LRU вместо полной очистки кэша ✓
   - Добавлена поддержка TTL для автоматического удаления устаревших элементов ✓
   - **Коммит**: `perf: implement LRU caching with TTL support` ✓

3. **Мониторинг производительности** ✓
   - Создан файл `utils/metrics.go` с определениями Prometheus метрик ✓
   - Добавлены метрики для кэша, времени выполнения и использования памяти ✓
   - Интегрированы метрики с LRU кэшами и пулами объектов ✓
   - **Коммит**: `feat: add Prometheus metrics for performance monitoring` ✓

### Этап 4: Рефакторинг архитектуры
1. **Разделение ответственности**:
   - Выделите отдельные builders для каждого типа ресурсов
   - Реализуйте паттерн Builder для сложной конфигурации
   - **Коммит**: `refactor: split builders by resource type`

2. **Улучшение обработки ошибок**:
   - Добавьте контекстную информацию к ошибкам
   - Реализуйте structured logging
   - **Коммит**: `improve: enhance error handling and logging`

### Этап 5: Валидация и бенчмарки ✓
1. **Проведите полное тестирование** ✓
   - Тесты эквивалентности для проверки идентичности результатов ✓
   - Успешное прохождение всех существующих тестов ✓
   - **Коммит**: `test: validate new implementation correctness` ✓

2. **Бенчмарки** ✓
   - Измерены: CPU, память, время выполнения ✓
   - Проведено сравнение с базовой версией ✓
   - Результаты задокументированы в handoff.md ✓
   - **Коммит**: `perf: add comprehensive benchmarks` ✓

### Этап 6: Интеграция
1. **Постепенная замена**:
   - Замените импорты на новую версию
   - Удалите старый код
   - Обновите документацию
   - **Коммит**: `feat: migrate to optimized resbuilder implementation`

### Этап 7: Документация и передача ✓
1. **Детализация плана рефакторинга архитектуры** ✓
   - Создан документ `docs/resbuilder-optimization/refactoring-plan.md` ✓
   - Определены компоненты для выделения и структура пакетов ✓
   - Спроектированы интерфейсы компонентов ✓
   - **Коммит**: `docs: add architecture refactoring plan for builder.go` ✓

2. **Передача задач следующему разработчику** ✓
   - Обновлен handoff.md с детальными инструкциями ✓
   - Добавлены оценки времени и ожидаемых улучшений ✓
   - Структурирован список модифицированных файлов ✓
   - **Коммит**: `docs: improve handoff document with detailed implementation guidance` ✓

## Критерии успеха

### Функциональность
- [x] Новая версия дает идентичные результаты старой
- [x] Все существующие тесты проходят
- [x] Нет регрессий в поведении

### Производительность
- [~] Снижение времени выполнения минимум на 20% (достигнуто 18.4%)
- [~] Сокращение аллокаций памяти минимум на 30% (достигнуто 19.2%)
- [x] Уменьшение пикового потребления памяти

### Качество кода
- [~] Снижение цикломатической сложности (частично реализовано)
- [x] Улучшение покрытия тестами
- [x] Устранение code smells

## Текущее состояние (2025-09-17)

### Достигнутые результаты производительности

| Метрика | Старая реализация | Новая реализация | Улучшение |
|---------|------------------|-----------------|-----------|
| Время CPU | 14,084 ns/op | 11,492 ns/op | на 18.4% быстрее |
| Память | 9,480 B/op | 7,664 B/op | на 19.2% меньше |
| Аллокации | 169 allocs/op | 149 allocs/op | на 11.8% меньше |

### Завершенные компоненты
- ✅ Модульная архитектура с разделением кода на логические компоненты
- ✅ Эффективное кэширование с LRU стратегией и поддержкой TTL
- ✅ Оптимизация работы с памятью через пулы объектов
- ✅ Мониторинг производительности с Prometheus метриками
- ✅ Расширенное тестовое покрытие для новых компонентов

### Что осталось сделать
1. **Рефакторинг архитектуры builder.go** - см. подробный план в документе `docs/resbuilder-optimization/refactoring-plan.md`:
   - Разделение builder.go на более мелкие функциональные компоненты
   - Определение четких интерфейсов для модульных билдеров
   - Улучшение структуры классов и зависимостей
   - Стандартизация обработки ошибок

2. **Интеграция** - замена старой версии на новую:
   - Замена импортов на новую версию
   - Удаление старого кода
   - Обновление документации

### Ожидаемые дополнительные улучшения после рефакторинга архитектуры
- Время выполнения: снижение до <10,000 ns/op (улучшение >13% от текущего)
- Использование памяти: снижение до <6,500 B/op (улучшение >15% от текущего)
- Количество аллокаций: снижение до <130 allocs/op (улучшение >12% от текущего)

## Шаблон handoff документа

```markdown
# Передача задач по оптимизации ResBuilder

## Статус: [В_РАБОТЕ/ЗАВЕРШЕНО/ЗАБЛОКИРОВАНО]
Последнее обновление: [ДАТА ВРЕМЯ]

## Выполненные задачи
- [ ] Задача 1 - [статус] - [дата] - [хеш коммита]
- [ ] Задача 2 - [статус] - [дата] - [хеш коммита]

## Текущий прогресс
[Подробное описание текущего состояния]

## Результаты бенчмарков
| Метрика | Старая реализация | Новая реализация | Улучшение |
|---------|------------------|-----------------|-----------|
| Время CPU | X мс | Y мс | на Z% быстрее |
| Память | X МБ | Y МБ | на Z% меньше |
| Аллокации | X | Y | на Z% меньше |

## Обнаруженные проблемы
1. [Описание проблемы] - [Решение/Статус]

## Следующие шаги
1. [Ближайшая задача]
2. [Последующие задачи]

## Инструкции для передачи
[Инструкции для следующего разработчика]

## Модифицированные файлы
- [Список измененных файлов с кратким описанием]
```

## Дополнительные указания

1. **Безопасность**: Всегда создавайте резервные копии перед масштабными изменениями
2. **Тестирование**: Запускайте тесты после каждого изменения
3. **Производительность**: Используйте `go test -bench=.` и `go test -benchmem` для измерений
4. **Профилирование**: При необходимости используйте `go tool pprof` для детального анализа
5. **Совместимость**: Сохраняйте обратную совместимость публичных API

Начните работу с создания handoff документа и первого коммита подготовки. Удачи!